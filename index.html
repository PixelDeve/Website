<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spike — Reddit-style Social</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; background: #f3f4f6; color: #111; }
    .scrollbar { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f3f4f6; }
    .scrollbar::-webkit-scrollbar { width: 8px; }
    .scrollbar::-webkit-scrollbar-track { background: #f3f4f6; }
    .scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  </style>
</head>
<body class="flex flex-col min-h-screen">
  <!-- Navbar -->
  <nav class="bg-white shadow-md sticky top-0 z-50">
    <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
      <span class="text-2xl font-bold">Spike</span>
      <div>
        <span id="userDisplay" class="mr-4 text-gray-700"></span>
        <button id="loginBtn" class="bg-indigo-600 text-white px-4 py-1 rounded">Login</button>
        <button id="logoutBtn" class="hidden bg-red-500 text-white px-4 py-1 rounded">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <main class="flex-grow max-w-3xl w-full mx-auto p-4 space-y-4">
    <!-- Create / Edit Post -->
    <form id="postForm" class="hidden bg-white p-4 rounded shadow flex flex-col space-y-2">
      <textarea id="postInput" rows="3" placeholder="What’s on your mind?" class="border p-2 rounded focus:outline-none"></textarea>
      <div class="flex justify-end space-x-2">
        <button type="submit" class="bg-indigo-600 text-white px-4 py-1 rounded">Post</button>
        <button id="cancelEdit" type="button" class="bg-gray-300 text-gray-700 px-4 py-1 rounded hidden">Cancel</button>
      </div>
    </form>

    <!-- Posts -->
    <div id="postFeed" class="space-y-4 scrollbar"></div>
  </main>

  <!-- Footer -->
  <footer class="bg-white p-4 text-center text-gray-500">© 2025 Spike</footer>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

    const firebaseConfig = { <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAPbvxBU0PYdgrHdHKCeqNAdiX0f-BdftY",
    authDomain: "pichat-b1206.firebaseapp.com",
    databaseURL: "https://pichat-b1206-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "pichat-b1206",
    storageBucket: "pichat-b1206.firebasestorage.app",
    messagingSenderId: "844622847426",
    appId: "1:844622847426:web:d76521621977b1d1074a5b",
    measurementId: "G-20QPP0S27J"
  };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let currentUser = null;
    let editPostId = null;

    // Elements
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userDisplay = document.getElementById('userDisplay');
    const postForm = document.getElementById('postForm');
    const postInput = document.getElementById('postInput');
    const cancelEdit = document.getElementById('cancelEdit');
    const postFeed = document.getElementById('postFeed');

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      currentUser = user;
      userDisplay.textContent = user ? `Hello, ${user.displayName}` : '';
      loginBtn.classList.toggle('hidden', !!user);
      logoutBtn.classList.toggle('hidden', !user);
      postForm.classList.toggle('hidden', !user);
      loadPosts();
    });

    postForm.onsubmit = async e => {
      e.preventDefault();
      const text = postInput.value.trim();
      if (!text) return;
      if (editPostId) {
        await updateDoc(doc(db, 'posts', editPostId), { content: text });
      } else {
        await addDoc(collection(db, 'posts'), { content: text, author: currentUser.displayName, authorId: currentUser.uid, createdAt: serverTimestamp(), comments: [] });
      }
      resetForm();
      loadPosts();
    };

    cancelEdit.onclick = resetForm;

    function resetForm() {
      postInput.value = '';
      editPostId = null;
      cancelEdit.classList.add('hidden');
    }

    async function loadPosts() {
      postFeed.innerHTML = '<p class="text-center text-gray-600">Loading...</p>';
      const snap = await getDocs(query(collection(db, 'posts'), orderBy('createdAt', 'desc')));
      postFeed.innerHTML = '';
      snap.forEach(docSnap => postFeed.appendChild(renderPost(docSnap.id, docSnap.data())));
    }

    function renderPost(id, post) {
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded shadow space-y-2';

      const header = document.createElement('div');
      header.className = 'flex justify-between items-center';
      const author = document.createElement('div');
      author.innerHTML = `<span class="font-semibold">${post.author}</span> • <span class="text-sm text-gray-500">${post.createdAt?.seconds ? new Date(post.createdAt.seconds*1000).toLocaleString() : 'Just now'}</span>`;
      header.appendChild(author);
      if (currentUser && currentUser.uid === post.authorId) {
        const controls = document.createElement('div');
        controls.innerHTML = `<button class="text-blue-600 mr-2">Edit</button><button class="text-red-600">Delete</button>`;
        controls.children[0].onclick = () => startEdit(id, post.content);
        controls.children[1].onclick = () => deleteDoc(doc(db, 'posts', id)).then(loadPosts);
        header.appendChild(controls);
      }
      card.appendChild(header);

      const content = document.createElement('p');
      content.className = 'whitespace-pre-wrap';
      content.textContent = post.content;
      card.appendChild(content);

      const commentSection = document.createElement('div');
      commentSection.className = 'mt-4 space-y-2';
      const addCommentBtn = document.createElement('button');
      addCommentBtn.className = 'text-indigo-600';
      addCommentBtn.textContent = 'Add comment';
      addCommentBtn.onclick = () => addComment(id);
      commentSection.appendChild(addCommentBtn);

      (post.comments || []).forEach(c => {
        const comDiv = document.createElement('div');
        comDiv.className = 'bg-gray-100 p-2 rounded';
        comDiv.innerHTML = `<span class="font-semibold">${c.author}</span>: ${c.text}`;
        commentSection.appendChild(comDiv);
      });

      card.appendChild(commentSection);
      return card;
    }

    function startEdit(id, text) {
      editPostId = id;
      postInput.value = text;
      cancelEdit.classList.remove('hidden');
      postInput.focus();
    }

    async function addComment(postId) {
      const txt = prompt('Your comment:');
      if (!txt) return;
      const postRef = doc(db, 'posts', postId);
      const snap = await getDocs(query(collection(db, 'posts')));
      const data = (await getDocs(postRef)).data();
      const comments = data.comments || [];
      comments.push({ author: currentUser.displayName, text: txt });
      await updateDoc(postRef, { comments });
      loadPosts();
    }
  </script>
</body>
</html>
