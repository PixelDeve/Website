<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PiChat Social</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; font-family:sans-serif; background:#e5ddd5; }
    button,input,textarea { border:none; outline:none; }
    nav { background:#128C7E; color:#fff; display:flex; }
    nav button { flex:1; padding:1rem; background:transparent; color:#fff; cursor:pointer; }
    #login { position:absolute; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.05); z-index:100; }
    #login button { padding:1rem 2rem; font-size:1.2rem; background:#4285F4; color:#fff; border-radius:.5rem; }
    #app { display:none; height:calc(100% - 60px); }
    section { display:none; height:100%; overflow-y:auto; padding:1rem; }
    .active { display:block; }
    /* Posts */
    #postForm { display:flex; flex-direction:column; margin-bottom:1rem; }
    #postForm textarea { resize:none; padding:.5rem; border:1px solid #ccc; border-radius:.5rem; height:60px; margin-bottom:.5rem; }
    #postForm select, #postForm button { padding:.5rem; border-radius:.5rem; margin-bottom:.5rem; }
    .post { background:#fff; padding:1rem; border-radius:.5rem; margin-bottom:1rem; }
    .post .actions { margin-top:.5rem; }
    .reaction { cursor:pointer; }
    /* Chats */
    #chatsSection { display:flex; flex-direction:row; height:100%; }
    #chatFriendsList { width:30%; border-right:1px solid #ccc; overflow-y:auto; }
    #chatContainer { flex:1; display:flex; flex-direction:column; }
    #chatWindow { flex:1; padding:1rem; background:#e5ddd5; overflow-y:auto; }
    .msg { max-width:70%; padding:.75rem; margin-bottom:1rem; border-radius:.5rem; position:relative; }
    .msg.sent { background:#dcf8c6; margin-left:auto; }
    .msg.recv { background:#fff; margin-right:auto; }
    .msg .status { font-size:.7rem; color:#666; position:absolute; bottom:-1.2rem; right:.5rem; }
    #chatFooter { display:flex; gap:.5rem; padding:1rem; background:#f0f2f5; border-top:1px solid #ccc; }
    #chatFooter input { flex:1; padding:.5rem; border:1px solid #ccc; border-radius:.5rem; }
    #chatFooter button { padding:.5rem 1rem; background:#128C7E; color:#fff; border-radius:.5rem; }
    #typingIndicator { font-style:italic; color:#666; margin-left:1rem; }
    /* Friends */
    #friendsList { overflow-y:auto; }
    /* Profile */
    #profileSection form { display:flex; flex-direction:column; margin-bottom:1rem; }
    #profileSection textarea { padding:.5rem; border:1px solid #ccc; border-radius:.5rem; margin-bottom:.5rem; }
    #profileSection button { padding:.5rem; background:#128C7E; color:#fff; border-radius:.5rem; }
    #myPosts { overflow-y:auto; }
    #myPosts .post { position:relative; background:#fff; padding:1rem; border-radius:.5rem; margin-bottom:1rem; }
    #myPosts button.delete { position:absolute; top:.5rem; right:.5rem; background:#f44336; color:#fff; border-radius:.25rem; padding:.25rem; cursor:pointer; }
    /* Responsive */
    @media(max-width:768px){ #chatsSection{flex-direction:column;} #chatFriendsList{width:100%;height:30%;} #chatContainer{height:70%;} }
  </style>
</head>
<body>
  <div id="login"><button id="loginBtn">Sign in with Google</button></div>
  <nav>
    <button id="navPosts">Posts</button>
    <button id="navChats">Chats</button>
    <button id="navFriends">Friends</button>
    <button id="navProfile">Profile</button>
  </nav>
  <div id="app">
    <section id="postsSection">
      <form id="postForm">
        <textarea id="postText" placeholder="What's on your mind?"></textarea>
        <select id="postPrivacy"><option value="public">Public</option><option value="friends">Friends</option></select>
        <button type="submit">Post</button>
      </form>
      <div id="posts"></div>
    </section>
    <section id="chatsSection">
      <ul id="chatFriendsList"></ul>
      <div id="chatContainer">
        <div id="typingIndicator" style="display:none;">Typing...</div>
        <div id="chatWindow"></div>
        <div id="chatFooter">
          <input id="chatInput" placeholder="Type a message..." />
          <button id="chatSend">Send</button>
        </div>
      </div>
    </section>
    <section id="friendsSection">
      <ul id="friendsList"></ul>
      <h3>All Users</h3>
      <ul id="usersList"></ul>
    </section>
    <section id="profileSection">
      <form id="profileEdit">
        <textarea id="bioInput" placeholder="Your bio..."></textarea>
        <button type="submit">Save Profile</button>
      </form>
      <h3>Your Posts</h3>
      <div id="myPosts"></div>
    </section>
  </div>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, getDoc, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const config = { apiKey:"AIzaSyAPbvxBU0PYdgrHdHKCeqNAdiX0f-BdftY", authDomain:"pichat-b1206.firebaseapp.com", databaseURL:"https://pichat-b1206-default-rtdb.asia-southeast1.firebasedatabase.app", projectId:"pichat-b1206", storageBucket:"pichat-b1206.firebasestorage.app", messagingSenderId:"844622847426", appId:"1:844622847426:web:d76521621977b1d1074a5b", measurementId:"G-20QPP0S27J" };
    const app = initializeApp(config), auth = getAuth(app), db = getFirestore(app), provider = new GoogleAuthProvider();

    const loginDiv=document.getElementById('login'), loginBtn=document.getElementById('loginBtn'), appDiv=document.getElementById('app');
    const navPosts=document.getElementById('navPosts'), navChats=document.getElementById('navChats'), navFriends=document.getElementById('navFriends'), navProfile=document.getElementById('navProfile');
    const postsSection=document.getElementById('postsSection'), chatsSection=document.getElementById('chatsSection'), friendsSection=document.getElementById('friendsSection'), profileSection=document.getElementById('profileSection');
    const postForm=document.getElementById('postForm'), postText=document.getElementById('postText'), postPrivacy=document.getElementById('postPrivacy'), postsDiv=document.getElementById('posts');
    const chatFriendsList=document.getElementById('chatFriendsList'), chatWindow=document.getElementById('chatWindow'), chatInput=document.getElementById('chatInput'), chatSend=document.getElementById('chatSend'), typingIndicator=document.getElementById('typingIndicator');
    const friendsList=document.getElementById('friendsList'), usersList=document.getElementById('usersList');
    const profileEdit=document.getElementById('profileEdit'), bioInput=document.getElementById('bioInput'), myPostsDiv=document.getElementById('myPosts');
    let currentUser, activeChatUser, unsubMsgs, unsubTyping;

    function show(section){ [postsSection,chatsSection,friendsSection,profileSection].forEach(s=>s.classList.remove('active')); section.classList.add('active'); }
    navPosts.onclick=()=>show(postsSection);
    navChats.onclick=()=>show(chatsSection);
    navFriends.onclick=()=>show(friendsSection);
    navProfile.onclick=()=>{ show(profileSection); loadProfile(); };

    loginBtn.onclick=()=>signInWithPopup(auth,provider);
    onAuthStateChanged(auth,user=>{ if(user){ currentUser=user; loginDiv.style.display='none'; appDiv.style.display='flex'; show(postsSection); loadUsersAndFriends(); loadPosts(); loadFriends(); } else{ loginDiv.style.display='flex'; appDiv.style.display='none'; } });
    document.getElementById('signOut').onclick=()=>signOut(auth);

    // POSTS
    postForm.onsubmit=async e=>{ e.preventDefault(); await addDoc(collection(db,'posts'),{ author:currentUser.uid, text:postText.value, privacy:postPrivacy.value, timestamp:serverTimestamp() }); postText.value=''; };
    function loadPosts(){ onSnapshot(query(collection(db,'posts'),orderBy('timestamp','desc')),snap=>{ postsDiv.innerHTML=''; myPostsDiv.innerHTML=''; snap.forEach(d=>{ const data=d.data(),id=d.id; if(data.privacy==='friends'){ getDoc(doc(db,'users',currentUser.uid,'friends',data.author)).then(ff=>{ if(ff.exists()) renderPost(id,data); }); } else renderPost(id,data); if(data.author===currentUser.uid) renderMyPost(id,data); }); }); }
    function renderPost(id,data){ const p=document.createElement('div'); p.className='post'; p.innerHTML=`<div><strong>${data.author}</strong></div><div>${data.text}</div><div class="actions"><span class="reaction" onclick="react('${id}')">üëç</span></div>`; postsDiv.appendChild(p); }
    function renderMyPost(id,data){ const p=document.createElement('div'); p.className='post'; const btn=document.createElement('button'); btn.textContent='Delete'; btn.className='delete'; btn.onclick=()=>deletePost(id); p.textContent=data.text; p.appendChild(btn); myPostsDiv.appendChild(p); }
    async function react(id){ await setDoc(doc(db,'posts',id,'reactions',currentUser.uid),{}); }
    async function deletePost(id){ await deleteDoc(doc(db,'posts',id)); }

    // USERS & FRIENDS
    async function loadUsersAndFriends(){ const usersSnap=await getDocs(collection(db,'users')); const friendsSnap=await getDocs(collection(db,'users',currentUser.uid,'friends')); const friends=new Set(); friendsSnap.forEach(d=>friends.add(d.id)); usersList.innerHTML=''; usersSnap.forEach(d=>{ const u=d.data(); if(u.uid===currentUser.uid) return; const li=document.createElement('li'); li.className='list-item'; li.textContent=u.name; const btn=document.createElement('button'); if(friends.has(u.uid)){ btn.textContent='Remove'; btn.onclick=()=>toggleFriend(u.uid,false); } else { btn.textContent='Add'; btn.onclick=()=>toggleFriend(u.uid,true); } li.appendChild(btn); usersList.appendChild(li); }); }
    async function loadFriends(){ const snap=await getDocs(collection(db,'users',currentUser.uid,'friends')); chatFriendsList.innerHTML=''; friendsList.innerHTML=''; snap.forEach(async d=>{ const uid=d.id; const uData=(await getDoc(doc(db,'users',uid))).data(); const li=document.createElement('li'); li.className='list-item'; li.textContent=uData.name; li.onclick=()=>openChat(uid); chatFriendsList.appendChild(li); friendsList.appendChild(li.cloneNode(true)); }); }
    async function toggleFriend(uid,add){ const ref=doc(db,'users',currentUser.uid,'friends',uid); if(add) await setDoc(ref,{}); else await deleteDoc(ref); loadUsersAndFriends(); loadFriends(); }

    // PROFILE
    profileEdit.onsubmit=async e=>{ e.preventDefault(); await setDoc(doc(db,'users',currentUser.uid),{ bio:bioInput.value },{ merge:true }); };
    async function loadProfile(){ const snap=await getDoc(doc(db,'users',currentUser.uid)); bioInput.value=(snap.data()||{}).bio||''; }

    // CHAT
    function openChat(uid){ activeChatUser=uid; show(chatsSection); chatWindow.innerHTML=''; if(unsubMsgs) unsubMsgs(); if(unsubTyping) unsubTyping(); const chatId=[currentUser.uid,uid].sort().join('_'); unsubMsgs=onSnapshot(query(collection(db,'chats',chatId,'messages'),orderBy('timestamp')),snap=>{ chatWindow.innerHTML=''; snap.forEach(msg=>{ const m=msg.data(), d=document.createElement('div'); d.className='msg '+(m.sender===currentUser.uid?'sent':'recv'); d.textContent=m.text; chatWindow.appendChild(d); }); chatWindow.scrollTop=chatWindow.scrollHeight; }); unsubTyping=onSnapshot(collection(db,'typing',chatId,'users'),snap=>{ let t=false; snap.forEach(d=>{ if(d.id!==currentUser.uid&&d.data().typing) t=true; }); typingIndicator.style.display=t?'block':'none'; }); }
    chatSend.onclick=sendChat; chatInput.oninput=()=>setTyping(chatInput.value.trim()!=='');
    function sendChat(){ const txt=chatInput.value.trim(); if(!txt||!activeChatUser) return; const chatId=[currentUser.uid,activeChatUser].sort().join('_'); addDoc(collection(db,'chats',chatId,'messages'),{ sender:currentUser.uid,text:txt,timestamp:serverTimestamp(),delivered:false,read:false }); chatInput.value=''; setTyping(false); }
    let typingTimeout; function setTyping(v){ if(!activeChatUser) return; const chatId=[currentUser.uid,activeChatUser].sort().join('_'); const ref=doc(db,'typing',chatId,'users',currentUser.uid); if(v){ setDoc(ref,{ typing:true }); clearTimeout(typingTimeout); typingTimeout=setTimeout(()=>setTyping(false),2000);} else setDoc(ref,{ typing:false }); }
  </script></body>
  </html>
